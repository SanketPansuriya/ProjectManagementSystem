
<div class="container" style="width:2000px">
<h1>Tasks</h1>
<p style="color: green"><%= notice %></p>
<div class="btn" style="background-color: #b4b4b4">
<%= link_to "Add New Task", new_project_task_path if can? :new, Task %>
</div>

<br><br>
<table style="text-align: center; border: 1px solid black" frame="VOID" rules="ALL">
  <tr  style="background-color: #DCDCDC;">
    <th style="padding: 10px">Task Name</th>
    <th style="padding: 10px">Description</th>
    <th style="padding: 10px">Employee Name</th>
    <th style="padding: 10px">Employee Email</th>
    <th style="padding: 10px">status</th>
    
    <th style="padding: 10px"> Action </th>

    <th style="padding: 10px"> Hours </th>  
  </tr>
  <% @tasks.each do |task| 
        employee = User.find(task.user_id)
  %>
  <tr style="background-color: #FFF0F5; padding:10px">
    <td>
      <%= task.title %>
      <%
        # params[:project_id] = task.sprint.project_id
        params[:task] = task.id
      %>
    </td>
     <td style="padding:10px">
      <%= task.description %>
    </td>
    <td style="padding:10px">
      <%= employee.name%>
    </td>
    <td style="padding:10px">
      <%= employee.email %>
    </td>
    <td style="padding:10px">
    <% if can? :edit, task%>
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="changeStatusDropDown_<%= task.id%>" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <%= task.status%>
        </button>
        <div class="dropdown-menu" aria-labelledby="changeStatusDropDown_<%= task.id%>">
          <% @status.each do |status| %>
            <%=  link_to(status[0], "#", {:class => "dropdown-item", "task_id" => task.id })%>
          <% end %>
      </div>
      <% else %>
      <%= task.status%>
      <% end %>
  </div>
    </td>
    <td style="padding:10px">
     <span style="background-color: #DDA0DD; margin:5px;padding:5px; border-radius:5px">
      <%= link_to "View", project_task_path(id: task) if can? :show, task  %></span>
      <span style="background-color: #DDA0DD; margin:5px;padding:5px; border-radius:5px">
      <%= link_to "Edit", edit_project_task_path(id: task) if (can? :edit, task) && (['manager', 'admin'].include? current_user.roles.first) %></span>
     <span style="background-color: #DDA0DD; margin:5px;padding:5px; border-radius:5px">
      <%= link_to "Delete", [task.sprint.project, task] , data: {
                    turbo_method: :delete,
                    turbo_confirm: "Are you sure?"
                  } if can? :destroy, task%></span>
    </td>
    <td >
      <%= @hours[task.id] %>

    </td>
  </tr>
    
  <% end %>

</table>
</div>

<script>
$(".dropdown-item").click(function(){
  // alert($(this).text());
  form = $(this);
  $.ajax({
    url: "task/update_task_status",
    type: "put",
    dataType: "json",
    data:  {task: {status: $(this).text(), id: form.attr('task_id')} },
    success: function(result) {
      button = $("#"+$(form).parent().attr('aria-labelledby'));
     button.fadeOut(800, function(){
        button.html(result["status"]).fadeIn().delay(850);

      });
    }
  });

      return false;
  });
</script>